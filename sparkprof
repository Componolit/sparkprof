#!/usr/bin/env python3

import re
import sys
import subprocess


COLOR_RED = '\033[0;31m'
COLOR_YELLOW = '\033[0;33m'
COLOR_NONE = '\033[0m'


args = [a for a in sys.argv[1:] if not a.startswith('--steps-warn=') and not a.startswith('--steps-error=')] + ['--report=statistics']

steps_warn  = next((int(x[13:]) for x in sys.argv[1:] if x.startswith('--steps-warn=')), None)
steps_error = next((int(x[14:]) for x in sys.argv[1:] if x.startswith('--steps-error=')), None)

max_steps = {}

gp = subprocess.Popen (['gnatprove'] + args, stdout = subprocess.PIPE, universal_newlines = True)
for line in gp.stdout:
    m = re.match('^((.*)\.ad.:.*) info: (.*)$', line)
    if m:
        unit = m.group(2)
        n = re.match('^(.*) proved \((.*): (.*) VC in max (\d.\d) seconds and (\d+) steps?\)(.*)$', m.group(3));
        if n:
            vcs = int(n.group(3))
            steps = int(n.group(5))
            emit = None
            if steps_error and steps >= steps_error:
                emit = COLOR_RED + "error"
            elif steps_warn and steps >= steps_warn:
                emit = COLOR_YELLOW + "warning"

            if emit:
                template = "{intro} {level}: too many steps: {type} proved ({prover}: {vcs} VC in " \
                           + "max ({time}) seconds and {steps} steps){rest}" + COLOR_NONE
                print(template.format(
                    intro  = m.group(1),
                    level  = emit,
                    type   = n.group(1),
                    prover = n.group(2),
                    vcs    = vcs,
                    time   = n.group(4),
                    steps  = steps,
                    rest   = n.group(6)))

            max_steps[unit] = max(steps, max_steps[unit] if unit in max_steps else 0)
    else:
        sys.stdout.write(line)

print("-" * 80)
for unit, steps in max_steps.items():
    print(f"{unit}: {steps} steps")
print(f"MAXIMUM: {max(max_steps.values())} steps")
